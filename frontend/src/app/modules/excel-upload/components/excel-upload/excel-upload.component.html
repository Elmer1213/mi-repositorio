<div class="excel-upload-container">
  <!-- ==============================
   Subida de Archivo
   ============================== -->
  <div
    class="drop-zone"
    [class.dragging]="isDragging"
    (dragover)="onDragOver($event)"
    (dragleave)="onDragLeave($event)"
    (drop)="onDrop($event)"
  >
    <p *ngIf="!selectedFile">Arrastra o selecciona un archivo Excel (.xlsx / .xls)</p>
    <p *ngIf="selectedFile">üìÑ Archivo seleccionado: {{ selectedFile.name }}</p>
    <input type="file" accept=".xlsx,.xls" (change)="onFileSelected($event)" hidden #fileInput />
    <button (click)="fileInput.click()">Seleccionar archivo</button>
  </div>

  <!-- üîπ CAMBIO 1: Usa los nuevos getters canPreview y canUpload -->
  <div class="actions">
    <button (click)="loadPreview()" [disabled]="!canPreview">üîç Previsualizar</button>
    <button (click)="uploadData()" [disabled]="!canUpload">Subir</button>
    <button (click)="downloadTemplate()">üì• Descargar plantilla</button>
  </div>

  <!-- ==============================
   Mensajes
   ============================== -->
  <div class="messages">
    <div class="error" *ngIf="errorMessage">{{ errorMessage }}</div>
    <div class="success" *ngIf="successMessage">{{ successMessage }}</div>
  </div>

  <!-- ==============================
  Progreso
  ============================== -->
  <div class="progress" *ngIf="isUploading">
    <p>Progreso: {{ uploadProgress }}%</p>
    <div class="bar">
      <div class="fill" [style.width.%]="uploadProgress"></div>
    </div>
  </div>

  <!-- ==============================
  Vista previa del Excel
  ============================== -->
  <div *ngIf="previewData" class="preview-section">
    <h3>Vista previa del archivo</h3>

    <!-- üîπ CAMBIO 2: Usa totalPreviewRows, hasPreviewErrors e invalidRowsCount -->
    <div class="preview-stats">
      <span class="stat">Total filas: {{ totalPreviewRows }}</span>
      <span class="stat" [class.error]="hasPreviewErrors">
        Errores detectados: {{ invalidRowsCount }}
      </span>
    </div>

    <table class="preview-table">
      <thead>
        <tr>
          <th>#</th>
          <th>Nombre</th>
          <th>Correo</th>
          <th>Estado</th>
          <th>Errores</th>
        </tr>
      </thead>
      <tbody>
        <!-- üîπ CAMBIO: Usa previewRows en lugar de previewData.rows -->
        <tr *ngFor="let row of previewRows" [class.invalid]="!row.is_valid">
          <td>{{ row.row_number || '-' }}</td>
          <td>{{ row.name || '‚Äî' }}</td>
          <td>{{ row.email || '‚Äî' }}</td>
          <td>{{ row.is_valid ? 'V√°lido' : 'Inv√°lido' }}</td>
          <td>
            <!-- üîπ CAMBIO 3: Sintaxis correcta para validar errores -->
            <ul class="error-list" *ngIf="row.errors && row.errors.length > 0">
              <li *ngFor="let error of row.errors">{{ error }}</li>
            </ul>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- ==============================
  Historial de cargas
  ============================== -->
  <div class="upload-history">
    <h3>Historial de cargas</h3>
    <table>
      <thead>
        <tr>
          <th>Archivo</th>
          <th>Fecha</th>
          <th>Estado</th>
          <th>Filas</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let log of uploadLogs">
          <td>{{ log.filename }}</td>
          <td>{{ log.uploaded_at | date: 'short' }}</td>
          <td [class]="getStatusClass(log.status.toLowerCase())">{{ getStatusText(log.status.toLowerCase()) }}</td>
          <td>{{ log.total_rows || '-' }}</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>